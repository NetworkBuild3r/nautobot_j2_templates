! Interfaces
{% for intf in interfaces | default([]) | sort(attribute='name') %}
{% if intf.name and not intf.name.startswith('Stack Port') %}
interface {{ intf.name }}

{# Description or uplink #}
{% set desc = intf.description | string | trim %}
{% set uplinks = interfaces | selectattr('lag', 'defined') | select('ne', None) | selectattr('lag.name', 'defined') | selectattr('lag.name', 'equalto', intf.name) | list %}
{% if desc %}
 description {{ desc }}
{% elif intf.name.startswith('Port-channel') and uplinks %}
 description UPLINK to {{ uplinks[0].description | default('unknown') | replace('Uplink to ', '') }} ({{ uplinks | map(attribute='name') | join(', ') }})
{% endif %}

{# IP Address #}
{% if intf.ip_addresses and intf.ip_addresses[0].address is defined %}
 {% set parts = intf.ip_addresses[0].address.split('/') %}
 {% if parts | length == 2 %}
  {% set prefix = parts[1] | int %}
  {% if prefix >= 0 and prefix <= 32 %}
 ip address {{ parts[0] }} {{ prefix | cidr_to_netmask }}
  {% endif %}
 {% endif %}
{% endif %}

{# VRF forward #}
{% if intf.vrf and intf.vrf.name %}
 vrf forwarding {{ intf.vrf.name }}
{% endif %}

{# Defaults and custom fields #}
{% set defaults = host.config_context.access_switch_defaults.interface_defaults | default({}) %}
{% set custom = intf._custom_field_data | default({}) %}

{# Mode/VLAN config #}
{% if intf.mode %}
 {% if intf.mode == 'ACCESS' and not intf.name.startswith('Port-channel') %}
  {% set vlan_id = (intf.untagged_vlan.vid if intf.untagged_vlan and intf.untagged_vlan.vid is defined else defaults.access_vlan) | int %}
  {% if vlan_id >= 1 and vlan_id <= 4094 %}
 switchport access vlan {{ vlan_id }}
 switchport mode access
  {% endif %}
 {% elif intf.mode in ['TAGGED', 'TAGGED_ALL'] or intf.name.startswith('Port-channel') %}
  {% set native_vlan = (intf.untagged_vlan.vid if intf.untagged_vlan and intf.untagged_vlan.vid is defined else defaults.access_vlan) | int %}
  {% if native_vlan >= 1 and native_vlan <= 4094 %}
 switchport trunk native vlan {{ native_vlan }}
  {% endif %}
  {% set trunk_list = intf.tagged_vlans | default([]) | selectattr('vid', 'defined') | map(attribute='vid') | map('int') | select('ge', 1) | select('le', 4094) | sort | join(',') %}
  {% if trunk_list %}
 switchport trunk allowed vlan {{ trunk_list }}
  {% endif %}
 switchport mode trunk
 switchport nonegotiate
 {% endif %}
{% endif %}

{# Voice VLAN #}
{% if custom.cf_voice_vlan and custom.cf_voice_vlan | int >= 1 and custom.cf_voice_vlan | int <= 4094 %}
 {% if defaults.voice_vlan is defined and defaults.voice_vlan | int == custom.cf_voice_vlan | int %}
 switchport voice vlan {{ custom.cf_voice_vlan }}
 {% endif %}
{% endif %}

{# Storm control #}
{% if custom.storm_control_level and custom.storm_control_level | string | length > 0 %}
 {% set level = custom.storm_control_level | string %}
 {% set unit = 'bps' if level.endswith('m') or level.endswith('k') else '' %}
 {% set clean_level = level | replace('m', '') | replace('k', '') %}
 {% if clean_level | float > 0 %}
 storm-control broadcast level {{ unit }} {{ clean_level }}
 {% endif %}
{% endif %}
{% if custom.storm_control_action and custom.storm_control_action | length > 0 and custom.storm_control_action[0] != 'drop' %}
 storm-control action {{ custom.storm_control_action[0] }}
{% endif %}

{# Spanning-tree features #}
{% if custom.portfast and defaults.spanning_tree_portfast %}
 spanning-tree portfast
{% endif %}
{% if custom.bpduguard and defaults.bpduguard %}
 spanning-tree bpduguard enable
{% endif %}

{# DHCP snooping #}
{% if custom.dhcp_snooping_limit and custom.dhcp_snooping_limit | int > 0 %}
 ip dhcp snooping limit rate {{ custom.dhcp_snooping_limit }}
{% endif %}
{% if custom.dhcp_snooping_trust %}
 ip dhcp snooping trust
{% endif %}

{# Channel-group #}
{% if intf.lag and intf.lag.name and not intf.name.startswith('Port-channel') %}
 channel-group {{ intf.lag.name | replace('Port-channel', '') | int }} mode active
{% endif %}

{# Enabled/shutdown #}
{% if intf.enabled %}
 no shutdown
{% else %}
 shutdown
{% endif %}
!
{% endif %}
{% endfor %}