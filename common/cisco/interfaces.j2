{%- macro render_storm_control(intf) -%}
{%- set level_cmd = '' -%}
{%- if intf._custom_field_data.get('storm_control_level') %}
{%- set level_cmd = 'storm-control broadcast level bps ' ~ intf._custom_field_data.get('storm_control_level') -%}
{%- else %}
{%- set level_cmd = 'storm-control broadcast level bps 20m' -%}
{%- endif %}
{%- set action_cmd = '' -%}
{%- if intf._custom_field_data.get('storm_control_action') %}
 {% set action_value = intf._custom_field_data.get('storm_control_action') %}
 {% if action_value is string %}
  {% set action = action_value %}
 {% elif action_value is iterable and action_value | length > 0 %}
  {% set action = action_value[0] %}
 {% else %}
  {% set action = none %}
 {% endif %}
 {% if action and action != 'drop' %}
{%- set action_cmd = 'storm-control action ' ~ action -%}
 {% endif %}
{%- else %}
{%- set action_cmd = 'storm-control action shutdown' -%}
{%- endif %}
{{ level_cmd }}{{ action_cmd }}
{%- endmacro -%}

{%- for intf in interfaces | sort(attribute='name') -%}
{%- set config_lines = [] -%}
{%- set _ = config_lines.append('interface ' ~ intf.name) -%}
{%- if intf.description and intf.description != 'Uplink to PEDC-A-DIST-SW01' %}
{%- set _ = config_lines.append(' description ' ~ intf.description) -%}
{%- endif %}
{%- if intf.ip_addresses %}
{%- set _ = config_lines.append(' ip address ' ~ intf.ip_addresses[0].address.split('/')[0] ~ ' ' ~ (intf.ip_addresses[0].address.split('/')[1] | int | cidr_to_netmask)) -%}
{%- endif %}
{%- if intf.mode == 'ACCESS' %}
 {%- if intf.untagged_vlan and intf.untagged_vlan.vid %}
 {%- set _ = config_lines.append(' switchport access vlan ' ~ intf.untagged_vlan.vid) -%}
 {%- endif %}
 {%- set _ = config_lines.append(' switchport mode access') -%}
 {%- if intf._custom_field_data.get('storm_control_level') %}
 {%- set _ = config_lines.append(' storm-control broadcast level ' ~ intf._custom_field_data.get('storm_control_level')) -%}
 {%- endif %}
 {%- if intf._custom_field_data.get('portfast') %}
 {%- set _ = config_lines.append(' spanning-tree portfast') -%}
 {%- endif %}
 {%- if intf._custom_field_data.get('bpduguard') %}
 {%- set _ = config_lines.append(' spanning-tree bpduguard enable') -%}
 {%- endif %}
 {%- if intf._custom_field_data.get('dhcp_snooping_limit') %}
 {%- set _ = config_lines.append(' ip dhcp snooping limit rate ' ~ intf._custom_field_data.get('dhcp_snooping_limit')) -%}
 {%- endif %}
{%- elif intf.mode == 'TAGGED_ALL' or intf.name.startswith('Port-channel') or intf.name == 'GigabitEthernet2' %}
 {%- set _ = config_lines.append(' switchport trunk native vlan 1000') -%}
 {%- if intf.tagged_vlans %}
 {%- set _ = config_lines.append(' switchport trunk allowed vlan ' ~ (intf.tagged_vlans | map(attribute='vid') | sort | join(','))) -%}
 {%- else %}
 {%- set _ = config_lines.append(' switchport trunk allowed vlan 2,102,1000') -%}
 {%- endif %}
 {%- set _ = config_lines.append(' switchport mode trunk') -%}
 {%- set _ = config_lines.append(' switchport nonegotiate') -%}
 {%- if intf.name in ['TenGigabitEthernet1/1/3', 'TenGigabitEthernet1/1/4'] %}
 {%- set _ = config_lines.append(' channel-group 1 mode active') -%}
 {%- endif %}
 {%- if intf._custom_field_data.get('dhcp_snooping_trust') %}
 {%- set _ = config_lines.append(' ip dhcp snooping trust') -%}
 {%- endif %}
 {%- set _ = config_lines.append(' ' ~ render_storm_control(intf)) -%}
{%- endif %}
{%- if not intf.enabled %}
{%- set _ = config_lines.append(' shutdown') -%}
{%- endif %}
{%- set _ = config_lines.append('!') -%}
{{ config_lines | join('') }}
{%- endfor -%}