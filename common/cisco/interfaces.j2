! Interfaces
{% for intf in interfaces | default([]) | sort(attribute='name') %}
{% if intf.name is defined and intf.name %}
interface {{ intf.name }}
 {%- if intf.description is defined and intf.description | string | length > 0 -%}
 description {{ intf.description }}
 {%- elif intf.name.startswith('Port-channel') and intf._custom_field_data is defined and intf.lag is not defined %}
  {%- set uplink_interfaces = interfaces | selectattr('lag', 'defined') | selectattr('lag.name', 'equalto', intf.name) | list %}
  {%- if uplink_interfaces | length > 0 %}
 description UPLINK to {{ uplink_interfaces[0].description | default('') | replace('Uplink to ', '') }}({{ uplink_interfaces | map(attribute='name') | join(', ') }})
  {% endif %}
 {% endif %}

 {%- if intf.ip_addresses is defined and intf.ip_addresses | length > 0 and intf.ip_addresses[0].address is defined %}
  {%- set ip_parts = intf.ip_addresses[0].address.split('/') %}
  {%- if ip_parts | length == 2 %}
   {%- set ip = ip_parts[0] %}
   {%- set prefix = ip_parts[1] | int %}
   {%- if prefix >= 0 and prefix <= 32 %}
 ip address {{ ip }} {{ prefix | cidr_to_netmask }}
   {% endif %}
  {% endif %}
 {% endif %}
 {%- if intf.vrf is defined and intf.vrf and intf.vrf.name is defined and intf.vrf.name | string | length > 0 %}
 vrf forwarding {{ intf.vrf.name }}
 {% endif %}
 {%- set defaults = host.config_context.access_switch_defaults.interface_defaults | default({}) %}
 {%- set custom = intf._custom_field_data | default({}) %}
 {%- if intf.mode is defined and intf.mode %}
  {% if intf.mode == 'ACCESS' and (intf.untagged_vlan is defined or defaults.access_vlan is defined) and not intf.name.startswith('Port-channel') %}
   {% if intf.untagged_vlan is defined and intf.untagged_vlan.vid is defined and intf.untagged_vlan.vid | int >= 1 and intf.untagged_vlan.vid | int <= 4094 %}
 switchport access vlan {{ intf.untagged_vlan.vid }}
   {% elif defaults.access_vlan is defined and defaults.access_vlan | int >= 1 and defaults.access_vlan | int <= 4094 %}
 switchport access vlan {{ defaults.access_vlan | int }}
   {% endif %}
 switchport mode access
  {% elif intf.mode in ['TAGGED', 'TAGGED_ALL'] or intf.name.startswith('Port-channel') %}
   {% if intf.untagged_vlan is defined and intf.untagged_vlan.vid is defined and intf.untagged_vlan.vid | int >= 1 and intf.untagged_vlan.vid | int <= 4094 %}
 switchport trunk native vlan {{ intf.untagged_vlan.vid }}
   {% elif defaults.access_vlan is defined and defaults.access_vlan | int >= 1 and defaults.access_vlan | int <= 4094 %}
 switchport trunk native vlan {{ defaults.access_vlan | int }}
   {% endif %}
   {% set vlan_list = intf.tagged_vlans | default([]) | selectattr('vid', 'defined') | map(attribute='vid') | map('int') | select('ge', 1) | select('le', 4094) | sort | join(',') %}
   {% if vlan_list | length > 0 %}
 switchport trunk allowed vlan {{ vlan_list }}
   {% endif %}
 switchport mode trunk
 switchport nonegotiate
  {% endif %}
 {% endif %}

 {% if not intf.name.startswith('Port-channel') %}
  {% if custom.cf_voice_vlan is defined and custom.cf_voice_vlan | int >= 1 and custom.cf_voice_vlan | int <= 4094 %}
   {% if defaults.voice_vlan is defined and defaults.voice_vlan | int == custom.cf_voice_vlan | int %}
 switchport voice vlan {{ custom.cf_voice_vlan }}
   {% endif %}
  {% endif %}
  {% if custom.portfast is defined and custom.portfast %}
   {% if defaults.spanning_tree_portfast is defined and defaults.spanning_tree_portfast %}
 spanning-tree portfast
   {% endif %}
  {% endif %}
  {% if custom.bpduguard is defined and custom.bpduguard %}
   {% if defaults.bpduguard is defined and defaults.bpduguard %}
 spanning-tree bpduguard enable
   {% endif %}
  {% endif %}
 {% endif %}

 {% if custom.storm_control_level is defined and custom.storm_control_level | string | length > 0 %}
  {% set level = custom.storm_control_level | string %}
  {% set unit = 'bps' if level.endswith('m') or level.endswith('k') else '' %}
  {% set clean_level = level | replace('m', '') | replace('k', '') %}
  {% if clean_level | float > 0 %}
 storm-control broadcast level {{ unit }} {{ clean_level }}
  {% endif %}
 {% endif %}
 {% if custom.storm_control_action is defined and custom.storm_control_action %}
  {% set action = custom.storm_control_action if custom.storm_control_action is string else (custom.storm_control_action | first if custom.storm_control_action | length > 0 else none) %}
  {% if action and action != 'drop' %}
 storm-control action {{ action }}
  {% endif %}
 {% endif %}

 {% if intf.lag is defined and intf.lag and intf.lag.name is defined and not intf.name.startswith('Port-channel') %}
 channel-group {{ intf.lag.name | replace('Port-channel', '') | int }} mode active
 {% endif %}

 {% if custom.dhcp_snooping_trust is defined and custom.dhcp_snooping_trust %}
 ip dhcp snooping trust
 {% endif %}
 {% if custom.dhcp_snooping_limit is defined and custom.dhcp_snooping_limit | int > 0 %}
 ip dhcp snooping limit rate {{ custom.dhcp_snooping_limit }}
 {% endif %}

 {% if intf.enabled is defined and intf.enabled %}
 no shutdown
 {% else %}
 shutdown
 {% endif %}
!
{%- endif %}
{% endfor %}