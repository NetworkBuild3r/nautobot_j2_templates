{# Robust Cisco IOS interface configuration template #}
{% for intf in interfaces | default([]) | sort(attribute='name') %}
{% if intf is defined and 'name' in intf and intf.name is defined and intf.name and not intf.name.startswith('Stack Port') %}
interface {{ intf.name }}
{# Description or uplink handling #}
{% set desc = (intf.description | string | trim) if 'description' in intf and intf.description is defined else '' %}
{% set uplinks = interfaces | default([]) | selectattr('lag', 'defined') | selectattr('lag', 'ne', None) | selectattr('lag.name', 'defined') | selectattr('lag.name', 'equalto', intf.name) | list %}
{% if desc %}
 description {{ desc }}
{% elif intf.name.startswith('Port-channel') and uplinks | length > 0 and uplinks[0] is defined and 'description' in uplinks[0] and uplinks[0].description is defined %}
 description UPLINK to {{ uplinks[0].description | default('unknown') | replace('Uplink to ', '') }} ({{ uplinks | map(attribute='name') | join(', ') }})
{% endif %}

{# IP Address handling #}
{% if 'ip_addresses' in intf and intf.ip_addresses is defined and intf.ip_addresses | length > 0 and intf.ip_addresses[0] is defined and 'address' in intf.ip_addresses[0] and intf.ip_addresses[0].address is defined %}
 {% set parts = intf.ip_addresses[0].address.split('/') %}
 {% if parts | length == 2 %}
  {% set prefix = parts[1] | int if parts[1] is defined else 0 %}
  {% if prefix >= 0 and prefix <= 32 %}
 ip address {{ parts[0] }} {{ prefix | cidr_to_netmask }}
  {% endif %}
 {% endif %}
{% endif %}

{# VRF forwarding #}
{% set vrf_defined = 'vrf' in intf and intf.vrf is defined and intf.vrf is not none %}
{% if vrf_defined and 'name' in intf.vrf and intf.vrf.name is defined %}
 vrf forwarding {{ intf.vrf.name }}
{% endif %}

{# Defaults and custom fields setup #}
{% set defaults = host.config_context.access_switch_defaults.interface_defaults if 'config_context' in host and host.config_context is defined and 'access_switch_defaults' in host.config_context and host.config_context.access_switch_defaults is defined and 'interface_defaults' in host.config_context.access_switch_defaults and host.config_context.access_switch_defaults.interface_defaults is defined else {} %}
{% set custom = intf._custom_field_data if '_custom_field_data' in intf and intf._custom_field_data is defined else {} %}

{# Mode/VLAN config #}
{% if 'mode' in intf and intf.mode is defined %}
 {% if intf.mode == 'ACCESS' and not intf.name.startswith('Port-channel') %}
  {% set vlan_id = (intf.untagged_vlan.vid | int if 'untagged_vlan' in intf and intf.untagged_vlan is defined and intf.untagged_vlan is not none and 'vid' in intf.untagged_vlan and intf.untagged_vlan.vid is defined else (defaults.access_vlan | int if 'access_vlan' in defaults and defaults.access_vlan is defined else 0)) %}
  {% if vlan_id >= 1 and vlan_id <= 4094 %}
 switchport access vlan {{ vlan_id }}
 switchport mode access
  {% endif %}
 {% elif intf.mode in ['TAGGED', 'TAGGED_ALL'] or intf.name.startswith('Port-channel') %}
  {% set native_vlan = (intf.untagged_vlan.vid | int if 'untagged_vlan' in intf and intf.untagged_vlan is defined and intf.untagged_vlan is not none and 'vid' in intf.untagged_vlan and intf.untagged_vlan.vid is defined else (defaults.access_vlan | int if 'access_vlan' in defaults and defaults.access_vlan is defined else 0)) %}
  {% if native_vlan >= 1 and native_vlan <= 4094 %}
 switchport trunk native vlan {{ native_vlan }}
  {% endif %}
  {% set trunk_list = (intf.tagged_vlans | default([]) | selectattr('vid', 'defined') | map(attribute='vid') | map('int') | select('ge', 1) | select('le', 4094) | sort | join(',') if 'tagged_vlans' in intf and intf.tagged_vlans is defined else '') %}
  {% if trunk_list %}
 switchport trunk allowed vlan {{ trunk_list }}
  {% endif %}
 switchport mode trunk
 switchport nonegotiate
 {% endif %}
{% endif %}

{# Voice VLAN #}
{% if 'voice_vlan' in custom and custom.voice_vlan is defined and custom.voice_vlan is not none and custom.voice_vlan | int >= 1 and custom.voice_vlan | int <= 4094 %}
 {% if 'voice_vlan' in defaults and defaults.voice_vlan is defined and defaults.voice_vlan | int == custom.voice_vlan | int %}
 switchport voice vlan {{ custom.voice_vlan }}
 {% endif %}
{% endif %}

{# Storm control #}
{% if 'storm_control_level' in custom and custom.storm_control_level is defined and custom.storm_control_level is not none and custom.storm_control_level | string | length > 0 %}
 {% set level = custom.storm_control_level | string %}
 {% set unit = 'bps' if level.endswith('m') or level.endswith('k') else '' %}
 {% set clean_level = level | replace('m', '') | replace('k', '') %}
 {% if clean_level | float > 0 %}
 storm-control broadcast level {{ unit }} {{ clean_level }}
 {% endif %}
{% endif %}
{% if 'storm_control_action' in custom and custom.storm_control_action is defined and custom.storm_control_action is not none and custom.storm_control_action | length > 0 and custom.storm_control_action[0] is defined and custom.storm_control_action[0] != 'drop' %}
 storm-control action {{ custom.storm_control_action[0] }}
{% endif %}

{# Spanning-tree features #}
{% if 'portfast' in custom and custom.portfast is defined and custom.portfast is not none and custom.portfast and 'spanning_tree_portfast' in defaults and defaults.spanning_tree_portfast is defined and defaults.spanning_tree_portfast %}
 spanning-tree portfast
{% endif %}
{% if 'bpduguard' in custom and custom.bpduguard is defined and custom.bpduguard is not none and custom.bpduguard and 'bpduguard' in defaults and defaults.bpduguard is defined and defaults.bpduguard %}
 spanning-tree bpduguard enable
{% endif %}

{# DHCP snooping #}
{% if 'dhcp_snooping_limit' in custom and custom.dhcp_snooping_limit is defined and custom.dhcp_snooping_limit is not none and custom.dhcp_snooping_limit | int > 0 %}
 ip dhcp snooping limit rate {{ custom.dhcp_snooping_limit }}
{% endif %}
{% if 'dhcp_snooping_trust' in custom and custom.dhcp_snooping_trust is defined and custom.dhcp_snooping_trust is not none and custom.dhcp_snooping_trust %}
 ip dhcp snooping trust
{% endif %}

{# Channel-group #}
{% set lag_defined = 'lag' in intf and intf.lag is defined and intf.lag is not none %}
{% if lag_defined and 'name' in intf.lag and intf.lag.name is defined and not intf.name.startswith('Port-channel') %}
 channel-group {{ intf.lag.name | replace('Port-channel', '') | int }} mode active
{% endif %}

{# Enabled/shutdown #}
{% if 'enabled' in intf and intf.enabled is defined and intf.enabled %}
 no shutdown
{% else %}
 shutdown
{% endif %}
!
{% endif %}
{% endfor %}