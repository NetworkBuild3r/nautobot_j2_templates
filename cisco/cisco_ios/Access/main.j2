hostname {{ host.name }}
{# SNMP Configuration Template with Secrets for Post-processing #}

{% set snmp = host.config_context['cisco_snmp_ios']['snmp'] %}

! SNMP Community Strings:
{% for comm in snmp['communities'] %}
  {% if comm['name'] in ["snmp_community_ro_placeholder", "snmp_community_rw_placeholder"] %}
snmp-server community {% raw %}{{ secrets_group["name"] | get_secret_by_secret_group_name(comm['name']|replace("_placeholder","")) | default("MISSING") }}{% endraw %} {{ comm['permission'] }} {{ comm['timeout'] }}
  {% else %}
snmp-server community {{ comm['name'] }} {{ comm['permission'] }} {{ comm['timeout'] }}
  {% endif %}
{% endfor %}

! SNMP Trap Source, Contact, and Location:
snmp-server trap-source {{ snmp['trap_source'] }}
snmp-server contact "{{ snmp['contact'] }}"
snmp-server location "{{ host.location }}"

! ACLs:
{% if snmp['acl_51'] %}
ip access-list standard 51
{% for acl in snmp['acl_51'] %}
  {{ acl }}
{% endfor %}
{% endif %}

{% if snmp['acl_60'] %}
ip access-list standard 60
{% for acl in snmp['acl_60'] %}
  {{ acl }}
{% endfor %}
{% endif %}

! Enabled SNMP Traps:
{% for trap in snmp['enable_traps'] %}
snmp-server enable traps {{ trap }}
{% endfor %}

! SNMP Host Entries with Secret Lookups:
{% for entry in snmp['hosts'] %}
snmp-server host {{ entry['ip'] }}
{% if entry['community'] == "snmp_community_ro_placeholder" %}
  {% raw %}{{ secrets_group["name"] | get_secret_by_secret_group_name("snmp_community_ro") | default("MISSING") }}{% endraw %}
{% elif entry['community'] == "snmp_community_rw_placeholder" %}
  {% raw %}{{ secrets_group["name"] | get_secret_by_secret_group_name("snmp_community_rw") | default("MISSING") }}{% endraw %}
{% else %}
  {{ entry['community'] }}
{% endif %}
{% endfor %}
