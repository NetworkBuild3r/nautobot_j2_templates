! Configuration for {{ host.hostname }}
hostname {{ host.hostname }}

! Global Settings
service timestamps debug datetime msec localtime show-timezone
service timestamps log datetime msec localtime show-timezone
service password-encryption
service call-home
enable secret <ENABLE_SECRET>

! VRF Definitions
{% for vrf in host.vrfs %}
vrf definition {{ vrf.name }}
 address-family ipv4
  exit-address-family
 address-family ipv6
  exit-address-family
{% endfor %}

! Interface Configurations
{% for intf in host.interfaces %}
interface {{ intf.name }}
  {% if intf.description %}
  description {{ intf.description }}
  {% endif %}
  {% if intf.name.startswith('Vlan') and intf.ip_addresses %}
  ip address {{ intf.ip_addresses[0].address.split('/')[0] }} {{ intf.ip_addresses[0].address.split('/')[1] | int | cidr_to_netmask }}
  {% endif %}
  {% if intf.vrf %}
  vrf forwarding {{ intf.vrf.name }}
  {% endif %}
  {% if intf.tagged_vlans %}
  switchport mode trunk
  switchport trunk allowed vlan {{ intf.tagged_vlans | map(attribute='vid') | join(',') }}
  {% if intf.untagged_vlan %}
  switchport trunk native vlan {{ intf.untagged_vlan.vid }}
  {% endif %}
  {% elif intf.untagged_vlan %}
  switchport mode access
  switchport access vlan {{ intf.untagged_vlan.vid }}
  {% endif %}
  {% if intf.enabled %}
  no shutdown
  {% else %}
  shutdown
  {% endif %}
{% endfor %}

! AAA Configuration
aaa new-model
aaa authentication login default {{ host.config_context.aaa.authentication.login.default }}
aaa authentication login console {{ host.config_context.aaa.authentication.login.console }}
aaa authentication enable default {{ host.config_context.aaa.authentication.enable }}
aaa authentication dot1x default {{ host.config_context.aaa.authentication.dot1x }}
aaa authorization exec default {{ host.config_context.aaa.authorization.exec }}
aaa authorization network default {{ host.config_context.aaa.authorization.network }}
aaa accounting exec vty start-stop {{ host.config_context.aaa.accounting.exec }}
aaa accounting commands 0 vty start-stop {{ host.config_context.aaa.accounting.commands['0'] }}
aaa accounting commands 15 vty start-stop {{ host.config_context.aaa.accounting.commands['15'] }}
{% for server in host.config_context.aaa.tacacs_servers %}
tacacs server {{ server.name }}
 address ipv4 {{ server.ip_address }}
 key <TACACS_KEY>
{% endfor %}

! SNMP Configuration
snmp-server trap-source {{ host.config_context.cisco_snmp_ios.snmp.trap_source }}
snmp-server contact "{{ host.config_context.cisco_snmp_ios.snmp.contact }}"
snmp-server location "{{ host.location.name }}"
{% for comm in host.config_context.cisco_snmp_ios.snmp.communities %}
snmp-server community <SNMP_COMMUNITY> {{ comm.permission }} {{ comm.timeout }}
{% endfor %}
{% for acl_number in ['51', '60'] %}
  {% set acl_key = 'acl_' ~ acl_number %}
  {% if acl_key in host.config_context.cisco_snmp_ios.snmp %}
ip access-list standard {{ acl_number }}
    {% for rule in host.config_context.cisco_snmp_ios.snmp[acl_key] %}
    {{ rule }}
    {% endfor %}
  {% endif %}
{% endfor %}
{% for trap in host.config_context.cisco_snmp_ios.snmp.enable_traps %}
snmp-server enable traps {{ trap }}
{% endfor %}
{% for host_ip in host.config_context.cisco_snmp_ios.snmp.hosts %}
snmp-server host {{ host_ip.ip }} <SNMP_COMMUNITY>
{% endfor %}

! NTP and Logging
ntp server {{ host.config_context.ntp.servers[0] }}
logging source-interface {{ host.config_context.syslog.source_interface }}
logging host {{ host.config_context.syslog.logging_host }}

! Line Configurations
line con 0
 {{ host.config_context.line_configs.console }}
line vty 0 4
 {{ host.config_context.line_configs.vty }}
 access-class 51 in
 transport input ssh
 transport output ssh

! Banner
banner motd ^C
{{ host.config_context.data.banner_motd }}
^C

! IP Settings
ip http server
ip http secure-server
ip http client source-interface {{ host.config_context.syslog.source_interface }}
ip tacacs source-interface {{ host.config_context.syslog.source_interface }}
ip ssh source-interface {{ host.config_context.syslog.source_interface }}
ip ssh version 2