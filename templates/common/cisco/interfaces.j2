!
{% for intf in interfaces %}
interface {{ intf.name }}
{% if intf.description %}
 description {{ intf.description }}
{% endif %}
{% if intf.ip_addresses %}
 ip address {{ intf.ip_addresses[0].address.split('/')[0] }} {{ intf.ip_addresses[0].address.split('/')[1] | int | cidr_to_netmask }}
{% endif %}
{% if intf.mode %}
 {% if intf.mode == 'ACCESS' %}
  switchport mode access
  {% if intf.untagged_vlan %}
  switchport access vlan {{ intf.untagged_vlan.vid }}
  {% endif %}
  {% if intf._custom_field_data.voice_vlan %}
  switchport voice vlan {{ intf._custom_field_data.voice_vlan }}
  {% endif %}
  {% if intf._custom_field_data.portfast %}
  spanning-tree portfast
  {% endif %}
  {% if intf._custom_field_data.bpduguard %}
  spanning-tree bpduguard enable
  {% endif %}
  {% if intf._custom_field_data.dhcp_snooping_limit %}
  ip dhcp snooping limit rate {{ intf._custom_field_data.dhcp_snooping_limit }}
  {% endif %}
  {% if intf._custom_field_data.storm_control_level %}
  storm-control broadcast level {{ intf._custom_field_data.storm_control_level }}
  {% endif %}
 {% elif intf.mode == 'TAGGED_ALL' %}
  switchport mode trunk
  switchport nonegotiate
  {% if intf.untagged_vlan %}
  switchport trunk native vlan {{ intf.untagged_vlan.vid }}
  {% endif %}
  switchport trunk allowed vlan {{ intf.tagged_vlans | map(attribute='vid') | join(',') if intf.tagged_vlans else 'all' }}
  {% if intf._custom_field_data.storm_control_level %}
  storm-control broadcast level {{ intf._custom_field_data.storm_control_level }}
  {% endif %}
  {% if intf._custom_field_data.storm_control_action and intf._custom_field_data.storm_control_action != 'drop' %}
  storm-control action {{ intf._custom_field_data.storm_control_action }}
  {% endif %}
  {% if intf._custom_field_data.dhcp_snooping_trust %}
  ip dhcp snooping trust
  {% endif %}
 {% endif %}
{% endif %}
{% if intf.lag %}
 {% set channel_number = intf.lag.name | regex_replace('^Port-Channel(\\d+)$', '\\1') %}
 channel-group {{ channel_number }} mode active
{% endif %}
{% if intf.enabled %}
 no shutdown
{% else %}
 shutdown
{% endif %}
!
{% endfor %}