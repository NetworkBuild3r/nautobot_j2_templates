{% macro config_key(intf) %}
  {{ intf.mode | default('') }}-{{ intf.untagged_vlan.vid | default('') }}-{{ intf.tagged_vlans | map(attribute='vid') | sort | join(',') | default('') }}-{{ intf._custom_field_data.voice_vlan | default('') }}-{{ intf._custom_field_data.storm_control_level | default('') }}-{{ intf._custom_field_data.storm_control_action | default('') }}-{{ intf._custom_field_data.portfast | default('') }}-{{ intf._custom_field_data.bpduguard | default('') }}-{{ intf._custom_field_data.dhcp_snooping_limit | default('') }}-{{ intf._custom_field_data.dhcp_snooping_trust | default('') }}-{{ intf._custom_field_data.channel_group | default('') }}-{{ intf.enabled | default('') }}
{% endmacro %}

{% set interface_groups = {} %}
{% for intf in interfaces | sort(attribute='name') %}
  {% set key = config_key(intf) %}
  {% if key in interface_groups %}
    {% set _ = interface_groups.update({key: interface_groups[key] + [intf]}) %}
  {% else %}
    {% set _ = interface_groups.update({key: [intf]}) %}
  {% endif %}
{% endfor %}

{% for key, group_interfaces in interface_groups.items() %}
{% set interface_names = group_interfaces | map(attribute='name') | list %}
interface range {{ interface_names | interface_range_compress }}
{% set intf = group_interfaces[0] %}
{% if intf.description %}
 description {{ intf.description }}
{% endif %}
{% if intf.ip_addresses %}
 ip address {{ intf.ip_addresses[0].address.split('/')[0] }} {{ intf.ip_addresses[0].address.split('/')[1] | int | cidr_to_netmask }}
{% endif %}
{% if intf.mode == 'ACCESS' %}
 switchport access vlan {{ intf.untagged_vlan.vid }}
 switchport mode access
 {% if intf._custom_field_data.voice_vlan %}
 switchport voice vlan {{ intf._custom_field_data.voice_vlan }}
 {% endif %}
 {% if intf._custom_field_data.storm_control_level %}
 storm-control broadcast level {{ intf._custom_field_data.storm_control_level }}
 {% endif %}
 {% if intf._custom_field_data.portfast %}
 spanning-tree portfast
 {% endif %}
 {% if intf._custom_field_data.bpduguard %}
 spanning-tree bpduguard enable
 {% endif %}
 {% if intf._custom_field_data.dhcp_snooping_limit %}
 ip dhcp snooping limit rate {{ intf._custom_field_data.dhcp_snooping_limit }}
 {% endif %}
{% elif intf.mode == 'TAGGED_ALL' %}
 switchport trunk native vlan {{ intf.untagged_vlan.vid }}
 switchport trunk allowed vlan {{ intf.tagged_vlans | map(attribute='vid') | sort | join(',') }}
 switchport mode trunk
 switchport nonegotiate
 {% if intf._custom_field_data.storm_control_level %}
 storm-control broadcast level bps {{ intf._custom_field_data.storm_control_level }}
 {% endif %}
 {% if intf._custom_field_data.storm_control_action and intf._custom_field_data.storm_control_action != 'drop' %}
 storm-control action {{ intf._custom_field_data.storm_control_action }}
 {% endif %}
 {% if intf._custom_field_data.channel_group %}
 channel-group {{ intf._custom_field_data.channel_group }} mode active
 {% endif %}
 {% if intf._custom_field_data.dhcp_snooping_trust %}
 ip dhcp snooping trust
 {% endif %}
 {% if not intf.enabled %}
 shutdown
 {% endif %}
{% endif %}
!
{% endfor %}